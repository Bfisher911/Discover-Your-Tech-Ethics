import React, { useState, useEffect, useRef } from 'react';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title } from 'chart.js';
import { Doughnut, Bar } from 'react-chartjs-2';

// --- Register Chart.js components ---
ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title);

// --- Add type definition for html2pdf on the window object ---
declare global {
  interface Window {
    html2pdf: any;
  }
}

// --- Favicon (Tiny SVG Rocket) ---
const FAVICON_SVG = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>";

// --- Type Definitions ---
type LensKey = 'CR' | 'DC' | 'DE' | 'UE' | 'UT' | 'VE' | 'SC' | 'CA';

interface QuizData {
  lenses: Record<LensKey, string>;
  blurbs: Record<LensKey, string>;
  questions: {
    id: number;
    text: string;
    options: {
      label: string;
      lens: LensKey;
    }[];
  }[];
}

// --- Quiz Content ---
const quizData: QuizData = {
  lenses: {
    CR: "Cultural Relativism",
    DC: "Divine Command",
    DE: "Kantian / Deontological",
    UE: "Ethical Egoism",
    UT: "Utilitarianism",
    VE: "Virtue Ethics / Golden Mean",
    SC: "Social Contract",
    CA: "Care Ethics"
  },
  blurbs: {
    CR: "You judge tech by the culture that birthed it; context is king. Expect to ask ‚ÄúWhose values?‚Äù before saying ‚Äúgood‚Äù or ‚Äúbad.‚Äù",
    DC: "You look skyward: moral code is divine decree. Tech is ethical when it honors that higher command.",
    DE: "Autonomy and duty steer you. If an algorithm overrides consent or treats people as a mere means to an end, you slam the brakes.",
    UE: "Enlightened self-interest fuels your calls. If a gadget or system boosts your personal flourishing and goals, you‚Äôre in.",
    UT: "You run the happiness calculus. The greatest good for the greatest number outweighs individual hang-ups every time.",
    VE: "Character first: the ‚Äògood technologist‚Äô cultivates balance, wisdom, and excellence in every click and creation.",
    SC: "Fair rules and transparent consent are your north star. Society must agree to the terms of the tech contract‚Äîor it‚Äôs void.",
    CA: "Empathy in action: you prioritize relationships, vulnerability, and the well-being of those affected by technology."
  },
  questions: [
    {
      id: 1,
      text: "A hospital's AI triage system must decide who receives the last available ventilator during a pandemic.",
      options: [
        { label: "Save the patient who will gain the greatest number of future life-years.", lens: "UT" },
        { label: "Adhere strictly to the hospital's first-come, first-served policy.", lens: "DE" },
        { label: "Consult with community spiritual leaders for a ruling based on the sanctity of life.", lens: "DC" },
        { label: "Prioritize your own close relatives or community members in your care.", lens: "CA" }
      ]
    },
    {
      id: 2,
      text: "An autonomous vehicle is about to crash. It must choose between swerving to hit one person or staying its course and hitting five.",
      options: [
        { label: "It has a duty not to take an action that kills, so it must stay its course.", lens: "DE" },
        { label: "It must swerve to minimize harm, saving the five people at the cost of one.", lens: "UT" },
        { label: "The car should protect its owner above all others, as that is its primary function.", lens: "UE" },
        { label: "The choice must be pre-determined by a public, agreed-upon regulation.", lens: "SC" }
      ]
    },
    {
      id: 3,
      text: "A company offers genetic editing to 'enhance' embryos, eliminating diseases but also allowing for selection of traits like intelligence.",
      options: [
        { label: "This fosters a virtuous society that values health and excellence.", lens: "VE" },
        { label: "It's 'playing God' and violates a sacred natural order.", lens: "DC" },
        { label: "The overall benefit to public health and happiness is undeniable.", lens: "UT" },
        { label: "It's wrong because it uses a future person as a means to the parents' ends.", lens: "DE" }
      ]
    },
    {
      id: 4,
      text: "An AI art generator is trained on billions of images, including copyrighted work, without permission from the original artists.",
      options: [
        { label: "This violates the implicit agreement that artists have ownership of their work.", lens: "SC" },
        { label: "It's a powerful tool for my own creative expression and efficiency.", lens: "UE" },
        { label: "The ethics depend on the specific cultural context of art and ownership.", lens: "CR" },
        { label: "A virtuous artist would respect sources and not seek unearned shortcuts.", lens: "VE" }
      ]
    },
    {
      id: 5,
      text: "A city deploys a 'predictive policing' algorithm that directs patrols to neighborhoods where it calculates crime is likely to occur.",
      options: [
        { label: "Using people's data this way, without their consent, is fundamentally wrong.", lens: "DE" },
        { label: "If it demonstrably reduces overall crime rates, it's a net positive for the city.", lens: "UT" },
        { label: "We must focus on how this system impacts the most vulnerable, potentially over-policed communities.", lens: "CA" },
        { label: "This is a breach of the social contract if not implemented with full public transparency and consent.", lens: "SC" }
      ]
    },
    {
      id: 6,
      text: "A government implements a mandatory 'social credit' system that rewards or punishes citizens based on their public behavior.",
      options: [
        { label: "This is an acceptable system if the rules are clear, public, and apply to everyone equally.", lens: "SC" },
        { label: "The system creates a more orderly and harmonious society, which is a greater good.", lens: "UT" },
        { label: "Such a system infringes on individual autonomy and dignity, regardless of its outcomes.", lens: "DE" },
        { label: "A wise and temperate person would not want their character judged by a crude point system.", lens: "VE" }
      ]
    },
    {
      id: 7,
      text: "An employer uses AI-powered surveillance software to monitor remote workers' productivity, tracking keystrokes and taking screenshots.",
      options: [
        { label: "This helps me prove my value and secure my position in the company.", lens: "UE" },
        { label: "Employment is a contract; if this is a condition, the employee can accept it or leave.", lens: "SC" },
        { label: "It violates the universal principle of respecting individual privacy and autonomy.", lens: "DE" },
        { label: "A caring manager would build trust rather than relying on invasive surveillance.", lens: "CA" }
      ]
    },
    {
      id: 8,
      text: "Deepfake technology is used to create realistic but fake videos for political satire, which could be mistaken for real footage.",
      options: [
        { label: "Whether this is acceptable depends on the specific society's views on speech and parody.", lens: "CR" },
        { label: "Deception is inherently wrong, regardless of the intent or outcome.", lens: "DE" },
        { label: "The potential for widespread misinformation outweighs any comedic or satirical value.", lens: "UT" },
        { label: "A virtuous communicator would pursue truth and clarity, not sophisticated falsehoods.", lens: "VE" }
      ]
    },
    {
      id: 9,
      text: "A company uses emotion-detecting AI to analyze candidates' facial expressions during video job interviews.",
      options: [
        { label: "This process is dehumanizing and fails to care for the candidate's well-being and anxiety.", lens: "CA" },
        { label: "Judging a person by involuntary micro-expressions is a violation of their dignity.", lens: "DE" },
        { label: "If it leads to better hires and a more successful company, the utility is clear.", lens: "UT" },
        { label: "This gives me an unfair advantage if I can learn to 'game' the system.", lens: "UE" }
      ]
    },
    {
      id: 10,
      text: "A brain-computer interface allows you to perfectly recall and replay your memories. It is offered as a commercial product.",
      options: [
        { label: "A balanced and wise life requires forgetting; perfect recall could be a curse.", lens: "VE" },
        { label: "The technology is wrong because it violates the inherent privacy of the mind.", lens: "DE" },
        { label: "This is the ultimate tool for self-improvement and achieving my personal goals.", lens: "UE" },
        { label: "This technology is forbidden as it interferes with the soul or spirit.", lens: "DC" }
      ]
    },
    {
      id: 11,
      text: "A company markets a friendly AI companion robot to combat loneliness in the elderly.",
      options: [
        { label: "This is a compassionate response to the suffering of loneliness and isolation.", lens: "CA" },
        { label: "The net happiness and comfort provided to the elderly justifies its use.", lens: "UT" },
        { label: "This is a great business idea that serves my goal of building a successful company.", lens: "UE" },
        { label: "In some cultures, family cares for elders, making this robot an inappropriate substitute.", lens: "CR" }
      ]
    },
    {
      id: 12,
      text: "A smart city's network of sensors sells aggregated, anonymized citizen movement data to private companies to fund free public transit.",
      options: [
        { label: "This is a fair social bargain if the terms are public and democratically approved.", lens: "SC" },
        { label: "The greater happiness and utility for thousands of commuters is the most important factor.", lens: "UT" },
        { label: "Selling citizen data, even anonymized, treats people as a means to an end.", lens: "DE" },
        { label: "We must consider how this data could disproportionately affect and expose marginalized groups.", lens: "CA" }
      ]
    }
  ]
};

// --- Helper Functions & Hooks ---

/**
 * Custom hook to manage state with localStorage persistence.
 * @param key The key to use for localStorage.
 * @param defaultValue The default value if nothing is in localStorage.
 * @returns A state and a function to update it.
 */
function usePersistentState<T>(key: string, defaultValue: T): [T, React.Dispatch<React.SetStateAction<T>>] {
  const [state, setState] = useState<T>(() => {
    try {
      const storedValue = window.localStorage.getItem(key);
      return storedValue ? JSON.parse(storedValue) : defaultValue;
    } catch (error) {
      console.error("Error reading from localStorage", error);
      return defaultValue;
    }
  });

  useEffect(() => {
    try {
      window.localStorage.setItem(key, JSON.stringify(state));
    } catch (error) {
      console.error("Error writing to localStorage", error);
    }
  }, [key, state]);

  return [state, setState];
}

/**
 * Calculates the final scores and determines the primary lens.
 * @param answers A record of the user's answers.
 * @returns An array of result objects, sorted by percentage.
 */
function calculateResults(answers: Record<number, LensKey>) {
  const scores: Record<LensKey, number> = { CR: 0, DC: 0, DE: 0, UE: 0, UT: 0, VE: 0, SC: 0, CA: 0 };
  const totalQuestions = quizData.questions.length;

  for (const questionId in answers) {
    const lens = answers[questionId];
    if (lens) {
      scores[lens]++;
    }
  }

  const results = (Object.keys(scores) as LensKey[]).map(lens => ({
    lens,
    name: quizData.lenses[lens],
    score: scores[lens],
    percent: Math.round((scores[lens] / totalQuestions) * 100),
    blurb: quizData.blurbs[lens],
  }));

  results.sort((a, b) => b.percent - a.percent);
  return results;
}


// --- UI Components ---

const Starfield = () => (
  <div className="absolute top-0 left-0 w-full h-full -z-20">
    <div className="absolute w-[1px] h-full bg-white animate-star-fall" style={{ left: '10%', animationDuration: '10s', animationDelay: '1s' }}></div>
    <div className="absolute w-[2px] h-full bg-white animate-star-fall" style={{ left: '20%', animationDuration: '8s', animationDelay: '3s' }}></div>
    <div className="absolute w-[1px] h-full bg-white animate-star-fall" style={{ left: '35%', animationDuration: '12s', animationDelay: '5s' }}></div>
    <div className="absolute w-[1px] h-full bg-white animate-star-fall" style={{ left: '50%', animationDuration: '9s', animationDelay: '2s' }}></div>
    <div className="absolute w-[2px] h-full bg-white animate-star-fall" style={{ left: '65%', animationDuration: '7s', animationDelay: '4s' }}></div>
    <div className="absolute w-[1px] h-full bg-white animate-star-fall" style={{ left: '80%', animationDuration: '11s', animationDelay: '6s' }}></div>
    <div className="absolute w-[1px] h-full bg-white animate-star-fall" style={{ left: '95%', animationDuration: '13s', animationDelay: '0s' }}></div>
  </div>
);

const GridOverlay = () => (
  <div
    className="absolute top-0 left-0 w-full h-full -z-10"
    style={{
      backgroundImage: `
        linear-gradient(to right, rgba(8, 25, 255, 0.2) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(8, 25, 255, 0.2) 1px, transparent 1px)
      `,
      backgroundSize: '40px 40px',
    }}
  ></div>
);

const Nebula = () => (
    <div className="absolute top-0 left-0 w-full h-full -z-10 opacity-40 mix-blend-screen animate-pulse-slow">
        <div className="absolute top-[-20%] left-[-20%] w-[60vw] h-[60vh] bg-radial-gradient-magenta rounded-full filter blur-3xl"></div>
        <div className="absolute bottom-[-20%] right-[-20%] w-[70vw] h-[70vh] bg-radial-gradient-cyan rounded-full filter blur-3xl"></div>
    </div>
);


const LandingPage = ({ onStart }: { onStart: () => void }) => (
  <div className="flex flex-col items-center justify-center h-full text-center p-4 animate-fade-in">
    <h1 className="text-5xl md:text-7xl font-orbitron text-shadow-glow-magenta mb-4">
      Technology Ethics
    </h1>
    <h2 className="text-3xl md:text-5xl font-orbitron text-shadow-glow-cyan mb-8">
      What Kind of Ethicist Are You?
    </h2>
    <p className="max-w-2xl mb-12 text-lg text-gray-300 font-inter">
      Navigate 12 challenging scenarios at the intersection of humanity and technology. Discover which ethical framework guides your digital conscience.
    </p>
    <button
      onClick={onStart}
      className="px-8 py-4 text-xl font-bold text-white uppercase transition-all duration-300 border-2 rounded-md bg-magenta/20 border-magenta font-orbitron hover:bg-magenta hover:text-black hover:shadow-glow-magenta focus:outline-none focus:ring-4 focus:ring-magenta/50"
    >
      Begin Quiz
    </button>
  </div>
);

const QuestionCard = ({
  question,
  onAnswer,
  currentQuestionIndex,
  totalQuestions
}: {
  question: QuizData['questions'][0];
  onAnswer: (lens: LensKey) => void;
  currentQuestionIndex: number;
  totalQuestions: number;
}) => {
  const [typedText, setTypedText] = useState('');

  useEffect(() => {
    setTypedText('');
    let i = 0;
    const interval = setInterval(() => {
      setTypedText(question.text.slice(0, i + 1));
      i++;
      if (i >= question.text.length) {
        clearInterval(interval);
      }
    }, 20);
    return () => clearInterval(interval);
  }, [question]);

  const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;

  return (
    <div className="w-full max-w-4xl p-6 mx-auto my-8 border-2 rounded-lg md:p-8 border-cyan/50 bg-black/50 backdrop-blur-sm animate-slide-in">
      <div className="mb-6">
        <div className="flex justify-between mb-2 text-sm font-orbitron text-cyan">
          <span>PROGRESS</span>
          <span>QUESTION {currentQuestionIndex + 1} / {totalQuestions}</span>
        </div>
        <div className="w-full h-4 rounded bg-cyan/20">
          <div
            className="h-4 rounded bg-gradient-to-r from-magenta to-cyan transition-all duration-500 ease-out"
            style={{ width: `${progress}%` }}
          ></div>
        </div>
      </div>

      <h2 className="mb-8 text-2xl md:text-3xl font-semibold leading-tight text-gray-100 min-h-[100px] md:min-h-[80px] font-inter">
        {typedText}
        <span className="inline-block w-2 h-8 ml-1 bg-synth-green animate-blink"></span>
      </h2>

      <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
        {question.options.map((option, index) => (
          <button
            key={index}
            onClick={() => onAnswer(option.lens)}
            className="p-4 text-left transition-all duration-300 border rounded-md border-magenta/50 text-gray-200 hover:bg-magenta/20 hover:border-magenta focus:outline-none focus:ring-4 focus:ring-magenta/50 focus:bg-magenta/20"
          >
            <span className="font-inter">{option.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
};

const ResultsPanel = ({ results, onRetake }: { results: ReturnType<typeof calculateResults>, onRetake: () => void }) => {
    const reportRef = useRef<HTMLDivElement>(null);
    const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
    const primaryLens = results[0];
    const chartData = {
        labels: results.map(r => r.name),
        datasets: [{
            data: results.map(r => r.percent),
            backgroundColor: [
                '#ff56f6', // magenta
                '#08f',    // laser-blue
                '#00ffa3', // synth-green
                '#f97316', // orange
                '#ec4899', // pink
                '#8b5cf6', // violet
                '#10b981', // emerald
                '#3b82f6', // blue
            ],
            borderColor: '#0d0d0d',
            borderWidth: 2,
        }],
    };
    
    const barChartData = {
        labels: results.map(r => r.name),
        datasets: [{
            label: '% Score',
            data: results.map(r => r.percent),
            backgroundColor: chartData.datasets[0].backgroundColor,
            borderColor: chartData.datasets[0].backgroundColor,
            borderWidth: 1,
        }],
    };

    const barChartOptions = {
        indexAxis: 'y' as const,
        elements: {
            bar: {
                borderWidth: 2,
            },
        },
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false,
            },
            title: {
                display: true,
                text: 'Your Ethical Framework Breakdown',
                color: '#e5e7eb',
                font: { size: 16, family: 'Orbitron' }
            },
        },
        scales: {
            x: {
                ticks: { color: '#9ca3af', font: { family: 'Inter' } },
                grid: { color: 'rgba(8, 25, 255, 0.2)' }
            },
            y: {
                ticks: { color: '#d1d5db', font: { family: 'Inter' } },
                grid: { color: 'rgba(8, 25, 255, 0.1)' }
            }
        }
    };

    const handleDownloadPdf = () => {
        if (isGeneratingPdf) return;
        setIsGeneratingPdf(true);

        const reportElement = reportRef.current;
        if (reportElement && window.html2pdf) {
            const pieChart = ChartJS.getChart('doughnut-chart');
            const barChart = ChartJS.getChart('bar-chart');
            const pieChartImg = pieChart?.toBase64Image();
            const barChartImg = barChart?.toBase64Image();

            const pieImgElement = reportElement.querySelector('#pdf-pie-chart-img') as HTMLImageElement;
            const barImgElement = reportElement.querySelector('#pdf-bar-chart-img') as HTMLImageElement;
            
            if (pieImgElement && pieChartImg) pieImgElement.src = pieChartImg;
            if (barImgElement && barChartImg) barImgElement.src = barChartImg;
            
            // Use a short timeout to allow images to render before capturing
            setTimeout(() => {
                const now = new Date();
                const filename = `ethics-quiz-${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}.pdf`;
                
                const opt = {
                    margin: 0.5,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, backgroundColor: '#0d0d0d', useCORS: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                window.html2pdf().from(reportElement).set(opt).save().then(() => {
                    setIsGeneratingPdf(false);
                }).catch(() => {
                    setIsGeneratingPdf(false);
                });
            }, 200); // 200ms delay to ensure rendering

        } else {
            console.error("PDF generation failed: html2pdf.js not loaded or report element not found.");
            setIsGeneratingPdf(false);
        }
    };

    return (
        <div className="w-full max-w-5xl p-4 mx-auto my-8 text-white animate-fade-in-slow">
            <h1 className="text-4xl text-center md:text-5xl font-orbitron text-shadow-glow-cyan mb-8">Results Analysis</h1>
            
            <div className="grid grid-cols-1 gap-8 lg:grid-cols-5">
                {/* Primary Lens Display */}
                <div className="p-6 border-2 rounded-lg lg:col-span-2 border-magenta/50 bg-black/50 backdrop-blur-sm">
                    <h2 className="mb-2 text-sm tracking-widest uppercase font-orbitron text-magenta">Your Primary Lens</h2>
                    <h3 className="mb-4 text-4xl font-semibold font-orbitron">{primaryLens.name}</h3>
                    <p className="text-lg text-gray-300 font-inter">{primaryLens.blurb}</p>
                    <div className="mt-6 text-6xl font-bold text-center font-orbitron text-shadow-glow-magenta">{primaryLens.percent}%</div>
                </div>

                {/* Doughnut Chart */}
                <div className="flex items-center justify-center p-6 border-2 rounded-lg lg:col-span-3 border-cyan/50 bg-black/50 backdrop-blur-sm">
                    <div className="w-full max-w-sm">
                       <Doughnut id="doughnut-chart" data={chartData} options={{
                           responsive: true,
                           plugins: {
                               legend: { position: 'top', labels: { color: '#e5e7eb', font: { family: 'Inter' } } },
                               title: { display: true, text: 'Ethical Lens Distribution', color: '#e5e7eb', font: { size: 16, family: 'Orbitron' } }
                           }
                       }} />
                    </div>
                </div>
            </div>

            {/* Bar Chart */}
            <div className="p-6 mt-8 border-2 rounded-lg border-synth-green/50 bg-black/50 backdrop-blur-sm">
                <div className="h-96">
                    <Bar id="bar-chart" options={barChartOptions} data={barChartData} />
                </div>
            </div>
            
            {/* Action Buttons */}
            <div className="flex flex-col items-center justify-center gap-4 mt-12 md:flex-row">
                <button
                    onClick={handleDownloadPdf}
                    disabled={isGeneratingPdf}
                    className="flex items-center justify-center gap-2 px-6 py-3 text-lg font-bold text-white uppercase transition-all duration-300 border-2 rounded-md bg-cyan/20 border-cyan font-orbitron hover:bg-cyan hover:text-black hover:shadow-glow-cyan focus:outline-none focus:ring-4 focus:ring-cyan/50 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className={`w-6 h-6 ${isGeneratingPdf ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        {isGeneratingPdf ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h5M20 20v-5h-5M4 4l16 16" />
                        ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        )}
                    </svg>
                    {isGeneratingPdf ? 'Generating...' : 'Download PDF Report'}
                </button>
                <button
                    onClick={onRetake}
                    className="flex items-center justify-center gap-2 px-6 py-3 text-lg font-bold text-white uppercase transition-all duration-300 border-2 rounded-md bg-magenta/20 border-magenta font-orbitron hover:bg-magenta hover:text-black hover:shadow-glow-magenta focus:outline-none focus:ring-4 focus:ring-magenta/50"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h5M20 20v-5h-5M4 4l16 16" /></svg>
                    Retake Quiz
                </button>
            </div>

            {/* Hidden div for PDF generation - modified for better rendering */}
            <div className="absolute top-0 left-0 w-[8.5in] opacity-0 -z-10 pointer-events-none" ref={reportRef}>
                <div className="h-[11in] bg-[#0d0d0d] text-white p-[0.5in]">
                    <div className="flex items-center justify-between pb-4 mb-4 border-b-2 border-cyan">
                        <h1 className="text-3xl font-orbitron">Ethics Report</h1>
                        <div className="text-right">
                            <p className="font-orbitron">Nebula Forge</p>
                            <p className="text-sm text-gray-400">Generated: {new Date().toLocaleString()}</p>
                        </div>
                    </div>
                    <h2 className="mt-6 mb-2 text-2xl text-center font-orbitron text-shadow-glow-magenta">Primary Lens: {primaryLens.name} ({primaryLens.percent}%)</h2>
                    <p className="mx-auto text-center text-gray-300 max-w-prose font-inter">{primaryLens.blurb}</p>
                    
                    <div className="flex justify-center my-8">
                        <img id="pdf-pie-chart-img" alt="Pie chart of results" className="w-full max-w-md" />
                    </div>
                    <h2 className="mt-8 mb-4 text-2xl text-center font-orbitron text-shadow-glow-cyan">Full Breakdown</h2>
                    <div className="flex justify-center">
                        <img id="pdf-bar-chart-img" alt="Bar chart of results" className="w-full max-w-lg" />
                    </div>
                </div>
            </div>
        </div>
    );
};


// --- Main App Component ---

export default function App() {
  type GameState = 'landing' | 'quiz' | 'results';
  const [gameState, setGameState] = usePersistentState<GameState>('ethicsQuizGameState', 'landing');
  const [answers, setAnswers] = usePersistentState<Record<number, LensKey>>('ethicsQuizAnswers', {});
  
  const currentQuestionIndex = Object.keys(answers).length;
  const currentQuestion = quizData.questions[currentQuestionIndex];
  
  useEffect(() => {
    // Set favicon
    const link = document.createElement('link');
    link.rel = 'icon';
    link.href = FAVICON_SVG;
    document.head.appendChild(link);
    
    document.title = "Tech Ethics Quiz";

    // Add fonts
    const fontLink = document.createElement('link');
    fontLink.href = "https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap";
    fontLink.rel = "stylesheet";
    document.head.appendChild(fontLink);

    // Load html2pdf.js from CDN to fix the resolution error
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    script.async = true;
    document.body.appendChild(script);

    // Cleanup function to remove the script when the component unmounts
    return () => {
      if (document.head.contains(link)) document.head.removeChild(link);
      if (document.head.contains(fontLink)) document.head.removeChild(fontLink);
      if (document.body.contains(script)) document.body.removeChild(script);
    };
  }, []);

  const handleStart = () => {
    setGameState('quiz');
  };

  const handleAnswer = (lens: LensKey) => {
    const newAnswers = { ...answers, [currentQuestion.id]: lens };
    setAnswers(newAnswers);

    if (currentQuestionIndex === quizData.questions.length - 1) {
      setGameState('results');
    }
  };

  const handleRetake = () => {
    setAnswers({});
    setGameState('landing');
  };

  const renderGameState = () => {
    switch (gameState) {
      case 'quiz':
        return currentQuestion ? (
          <QuestionCard
            question={currentQuestion}
            onAnswer={handleAnswer}
            currentQuestionIndex={currentQuestionIndex}
            totalQuestions={quizData.questions.length}
          />
        ) : <ResultsPanel results={calculateResults(answers)} onRetake={handleRetake} />;
      case 'results':
        return <ResultsPanel results={calculateResults(answers)} onRetake={handleRetake} />;
      case 'landing':
      default:
        return <LandingPage onStart={handleStart} />;
    }
  };

  return (
    <main className="relative min-h-screen overflow-hidden font-sans bg-black text-gray-50">
      <Starfield />
      <GridOverlay />
      <Nebula />
      <div className="relative z-10 flex items-center justify-center min-h-screen p-4">
        {renderGameState()}
      </div>
      <style>{`
        :root {
          --color-magenta: #ff56f6;
          --color-cyan: #08f;
          --color-synth-green: #00ffa3;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .text-shadow-glow-magenta { text-shadow: 0 0 8px var(--color-magenta), 0 0 12px var(--color-magenta); }
        .text-shadow-glow-cyan { text-shadow: 0 0 8px var(--color-cyan), 0 0 12px var(--color-cyan); }
        .shadow-glow-magenta { box-shadow: 0 0 15px var(--color-magenta), 0 0 25px var(--color-magenta); }
        .shadow-glow-cyan { box-shadow: 0 0 15px var(--color-cyan), 0 0 25px var(--color-cyan); }
        .bg-radial-gradient-magenta { background-image: radial-gradient(circle, rgba(255, 86, 246, 0.5) 0%, rgba(255, 86, 246, 0) 60%); }
        .bg-radial-gradient-cyan { background-image: radial-gradient(circle, rgba(0, 136, 255, 0.5) 0%, rgba(0, 136, 255, 0) 60%); }
        
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.8s ease-out forwards; }
        
        @keyframes fade-in-slow {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .animate-fade-in-slow { animation: fade-in-slow 1.5s ease-out forwards; }

        @keyframes slide-in {
          from { opacity: 0; transform: translateX(-30px); }
          to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in { animation: slide-in 0.5s ease-out forwards; }
        
        @keyframes blink {
          50% { opacity: 0; }
        }
        .animate-blink { animation: blink 1s step-end infinite; }

        @keyframes star-fall {
            from { transform: translateY(-100vh); }
            to { transform: translateY(100vh); }
        }
        .animate-star-fall { animation: star-fall linear infinite; }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }
        .animate-pulse-slow { animation: pulse-slow 15s ease-in-out infinite; }

        @media (prefers-reduced-motion: reduce) {
          *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
          }
        }
      `}</style>
    </main>
  );
}
